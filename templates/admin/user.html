{% extends 'admin/admin_base.html' %}

{% block admin_content %}
<script src="{{ url_for('static', filename='js/user_profile.js') }}"></script>
<div class="profile-main-section__wrapper">
    <div class="content-label">Профиль пользователя {{ user_id }}</div>
    <form id="profileForm" method="post">
        <div class="profile-info-group">
            <span class="profile-info-group__text">Контактные данные</span>
            <div class="input-group mb-3">
                <span class="input-group-text">Телефон</span>
                {{form.phone(class='form-control', placeholder='+7')}}
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text" id="input-email-label">E-mail</span>
                {{form.email(class='form-control', placeholder='example@mail.ru')}}

            </div>
        </div>
        <div class="profile-info-group">
            <span class="profile-info-group__text">Личные данные</span>
            <div class="input-group mb-3">
                <span class="input-group-text">Фамилия</span>
                {{form.surname(class='form-control', placeholder='Фамилия')}}
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Имя</span>
                {{form.name(class='form-control', placeholder='Имя')}}
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Отчество</span>
                {{form.patronymic(class='form-control', placeholder='Отчество')}}
            </div>
        </div>
        <div class="profile-info-group">
            <span class="profile-info-group__text">Дата рождения</span>
            {{form.birth_date(class='form-control input-group')}}
        </div>
        <div class="profile-info-group">
            <span class="profile-info-group__text">Ваш пол</span>
            <div class="input-group"
                 style="display: grid; grid-template-rows: 100%; grid-template-columns: 100px auto; column-gap: 20px">
                {% for subfield in form.sex %}
                <div class="radio-group">
                    <span class="radio-checkbox">{{ subfield }}</span>
                    <span>{{ subfield.label }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="submit__wrapper">
            <input class="btn btn-secondary save-btn input-group" type="submit" value="Сохранить">
<!--            {% if admin_role == 4 %}-->
<!--            <button class="btn btn-danger save-btn input-group" value="" id="delete-btn" style="display: inline; width: 240px">Удалить пользователя</button>-->
<!--            <script>-->
<!--                const user_id = {{user_id|tojson}}-->
<!--                document.getElementById('delete-btn').addEventListener('click', () => {-->
<!--                    fetch('/api/users/' + user_id, {method: 'DELETE'}).then(res => {-->
<!--                        if (res.ok) {-->
<!--                            document.getElementById('save-status-text').innerHTML = "Пользователь удален"-->
<!--                            document.querySelectorAll("input").forEach(input => {-->
<!--                                input.disabled = true;-->
<!--                            });-->
<!--                        }-->
<!--                        })-->
<!--                })-->


<!--            </script>-->
<!--            {% endif %}-->
            <span id="save-status-text">{{status_text}}</span>
        </div>
    </form>
</div>
<script>
    const userId = {{user_id|tojson}}

    loadUser(userId).then(data => {
        const user = data['user']
        localStorage.setItem("cached_user", JSON.stringify(user));
    });
    const admin_role = {{admin_role|tojson}}
    const inputs = document.querySelectorAll("input");
    if (admin_role != 4) {
        inputs.forEach(input => {
            input.disabled = true;
        });
    };
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const cached = localStorage.getItem("cached_user");
        if (!cached) return;

        const data = JSON.parse(cached);

        const fillIfExists = (id, value) => {
            const el = document.getElementById(id);
            if (el && value !== undefined) el.value = value;
        };

        fillIfExists("phone", data.phone);
        fillIfExists("email", data.email);
        fillIfExists("surname", data.surname);
        fillIfExists("name", data.name);
        fillIfExists("patronymic", data.patronymic);
        fillIfExists("birth_date", data.birth_date);

        // Пол: выбираем radio с нужным value
        if (data.sex) {
            const sexRadio = document.querySelector(`input[name="sex"][value="${data.sex}"]`);
            if (sexRadio) sexRadio.checked = true;
        }
    });
</script>
{% endblock %}